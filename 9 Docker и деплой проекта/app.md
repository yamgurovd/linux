# Инструкция по запуску FastAPI и Celery с помощью bash-скрипта

---

## Краткое содержание инструкции

В данной инструкции описывается процесс запуска вашего FastAPI-приложения и Celery-воркеров с использованием
bash-скрипта `app.sh`. Скрипт активирует виртуальное окружение по абсолютному пути и последовательно запускает сервер
Uvicorn и два процесса Celery (обычный worker и worker с beat). Это позволяет удобно стартовать все необходимые сервисы
одним запуском.

---

## Краткое содержание происходящего

1. **Активация виртуального окружения**  
   Скрипт активирует Python-окружение, чтобы использовать все установленные зависимости.

2. **Запуск сервера FastAPI (Uvicorn)**  
   Запускается сервер на `0.0.0.0:8000` с автоматической перезагрузкой при изменениях в коде.

3. **Запуск Celery worker**  
   Запускается Celery worker для обработки фоновых задач.

4. **Запуск Celery worker с beat**  
   Запускается Celery worker с планировщиком задач (beat) для периодических заданий.

5. **Ожидание завершения процессов**  
   Скрипт удерживает сессию активной, пока работают все процессы.

---

## Что происходит в целом

Скрипт упрощает запуск всех необходимых компонентов проекта FastAPI с Celery, обеспечивая правильную активацию окружения
и параллельный запуск сервисов. Это позволяет быстро стартовать проект и удобно контролировать процессы.

---

## Таблица команд и действий

| Действие/Команда                                                        | Описание                                               |
|-------------------------------------------------------------------------|--------------------------------------------------------|
| `source /home/d/PycharmProjects/fastapi/venv/bin/activate`              | Активация виртуального окружения по абсолютному пути   |
| `uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload &`            | Запуск FastAPI сервера в фоне с автообновлением        |
| `celery --app=src.tasks.celery_app:celery_instance worker -l info &`    | Запуск Celery worker в фоне                            |
| `celery --app=src.tasks.celery_app:celery_instance worker -l info -B &` | Запуск Celery worker с beat (планировщик задач) в фоне |
| `wait`                                                                  | Ожидание завершения всех запущенных процессов          |

---

## Пояснения

- **Виртуальное окружение** — изолированная среда Python с нужными библиотеками проекта.
- **Uvicorn** — ASGI-сервер для запуска FastAPI-приложения.
- **Celery worker** — процесс для выполнения асинхронных задач.
- **Beat** — планировщик периодических задач Celery.
- **Фоновый запуск (&)** — позволяет запускать процессы параллельно.
- **Команда `wait`** — удерживает скрипт активным, пока работают все процессы.

#### Пример запуска

![Dbeaver](/course_helpers/9%20Docker%20и%20деплой%20проекта/app_bash_script.png)
---

# Подробная инструкция

---

### 1. Создайте файл скрипта `app.sh`

В корне вашего проекта создайте файл `app.sh` со следующим содержимым:

```text
#!/bin/bash

echo "Активируем виртуальное окружение..."
source /home/d/PycharmProjects/fastapi/venv/bin/activate

echo "Запускаем Uvicorn сервер на 0.0.0.0:8000 с автообновлением..."
uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload &

echo "Запускаем Celery worker..."
celery --app=src.tasks.celery_app:celery_instance worker -l info &

echo "Запускаем Celery worker с beat (планировщик задач)..."
celery --app=src.tasks.celery_app:celery_instance worker -l info -B &

echo "Все процессы запущены. Ожидание завершения..."
wait
```

---

### 2. Сделайте скрипт исполняемым

В терминале выполните команду:

```shell
chmod +x app.sh
```

---

### 3. Запустите скрипт

Для запуска всех сервисов выполните:

```shell
./app.sh
```

*Примечание* - Запуск необходимо производить на той же директории, где находится `app.sh`

Вы увидите поэтапные сообщения о запуске каждого компонента.

---

### 4. Остановка сервисов

Для остановки запущенных процессов нажмите `Ctrl+C` в терминале, где запущен скрипт.

---

## Итог

- Вы создали удобный bash-скрипт для запуска FastAPI и Celery.
- Скрипт активирует виртуальное окружение по абсолютному пути.
- Все процессы запускаются параллельно с информативным выводом.
- Скрипт удерживает сессию активной до завершения работы сервисов.

Теперь запуск вашего проекта сводится к одной команде — `./app.sh`, что упрощает разработку и отладку.

---
