# 6.11 Про IPTables


---

## Конспект

### Команды IPTables для фильтрации и управления трафиком

| Команда                                                                                                      | Описание и пример использования                                                                                                                   |
|--------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------|
| `iptables -L`                                                                                                | Просмотр текущих правил всех цепочек таблицы filter.                                                                                              |
| `iptables -A INPUT -s 192.168.0.100 -j DROP`                                                                 | Блокировка всего входящего трафика от IP-адреса 192.168.0.100.                                                                                   |
| `iptables -A INPUT -p tcp --dport 22 -j ACCEPT`                                                               | Разрешение входящего трафика TCP на порт 22 (SSH).                                                                                                |
| `iptables -P INPUT DROP`                                                                                      | Установка политики по умолчанию для цепочки INPUT на DROP (отклонять все не разрешённые пакеты).                                                 |
| `iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080`                                  | Перенаправление входящего трафика с порта 80 на порт 8080 (NAT, проброс портов).                                                                 |
| `iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m limit --limit 3/min -j ACCEPT`                     | Ограничение количества новых SSH-подключений (порт 22) до 3 в минуту.                                                                             |
| `iptables -F`                                                                                                | Очистка всех правил (флешинг таблиц).                                                                                                            |
| `iptables -X`                                                                                                | Удаление всех пользовательских цепочек.                                                                                                          |
| `iptables-save`                                                                                              | Сохранение текущих правил iptables (например, для резервного копирования).                                                                       |
| `iptables-restore`                                                                                           | Восстановление правил из сохранённого файла.                                                                                                    |
| `iptables -I INPUT 1 -p tcp --dport 17500 -s 10.0.0.85 -j ACCEPT -m comment --comment "Friendly Dropbox"`     | Вставка правила в начало цепочки INPUT, разрешающего доступ к порту 17500 только с IP 10.0.0.85 с комментарием.                                |
| `iptables -R INPUT 2 -p tcp --dport 17500 -j REJECT --reject-with icmp-port-unreachable`                      | Замена правила №2 в цепочке INPUT для отклонения доступа к порту 17500 с отправкой ICMP сообщения об ошибке.                                      |
| `iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT`                                      | Разрешение пакетов, относящихся к уже установленным и связанным соединениям.                                                                    |
| `iptables -I INPUT 1 -i lo -j ACCEPT`                                                                         | Разрешение всего трафика с loopback интерфейса (локальные соединения).                                                                           |
| `iptables -A INPUT -p tcp --dport 443 -j ACCEPT`                                                            | Разрешение входящего HTTPS-трафика на порт 443.                                                                                                 |
| `iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT`                                              | Разрешение ICMP echo request (ping) запросов.                                                                                                   |
| `iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW -m limit --limit 3/min --limit-burst 3 -j ACCEPT` | Ограничение новых SSH-подключений до 3 в минуту с всплеском в 3 для защиты от DoS атак по SSH.                                                    |
| `iptables -A INPUT -p tcp --dport 22 -j DROP`                                                               | Отклонение всех остальных попыток подключения к SSH, не попавших под ограничение лимита.                                                        |
| `iptables -A INPUT -s 5.6.7.8 -j DROP`                                                                       | Бан IP-адреса 5.6.7.8 — полное блокирование трафика с данного адреса.                                                                           |
| `iptables --version`                                                                                         | Проверка установленной версии утилиты IPTables.                                                                                                 |



1. Введение в сетевую безопасность
- В предыдущей лекции изучили SSH и SCP для взаимодействия с удалёнными серверами.
- Акцент на необходимости аутентификации и свободного сетевого соединения.
2. Необходимость сетевой безопасности

![BPMN-схема бизнес-процесса](/6%20%20Доступ%20и%20права/Ip.png)


- В множественных сетевых средах важно ограничивать доступ к службам через аппаратные файрволы или через IP Tables для каждого сервера.
3. Аппаратные файрволы


![BPMN-схема бизнес-процесса](/6%20%20Доступ%20и%20права/Ip2.png)


- Устройства Cisco серии ASA, Huawei USG, Fortinet FortiGate, Palo Alto Networks и GFW контролируют трафик на входе/выходе сетей.
4. IP Tables как инструмент Linux для фильтрации трафика

![BPMN-схема бизнес-процесса](/6%20%20Доступ%20и%20права/Ip3.png)

- Введение в IP Tables для контроля сетевого трафика на уровне каждого сервера.
- Пример с настройкой сетевой безопасности в среде приложения Palmi.
5. Настройка IP Tables

![BPMN-схема бизнес-процесса](/6%20%20Доступ%20и%20права/Ip4.png)

- Установка IP Tables в различных дистрибутивах Linux.
- Структура и функции цепочек в IP Tables: INPUT, OUTPUT, FORWARD.
- Принцип работы цепочек и правил в IP Tables для определения действий с пакетами (ACCEPT, DROP).
6. Пример конфигурации правил

![BPMN-схема бизнес-процесса](/6%20%20Доступ%20и%20права/Ip5.png)

- Создание настройки для: ограничения доступа по SSH, разрешения доступа к определённым портам и путям, ограничения входящего и исходящего трафика для конкретных сервисов и IP-адресов.
7. Финал и предварительные итоги


![BPMN-схема бизнес-процесса](/6%20%20Доступ%20и%20права/Ip5.png)

- Обзор возможностей указания условий в правилах по источнику трафика, направлению, порту и протоколу.
- Анонс следующей лекции, где будет демонстрация практической настройки IP Tables.

---