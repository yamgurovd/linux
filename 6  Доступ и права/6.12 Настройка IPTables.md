# 6.12 Настройка IPTables


---


## Конспект

### Команды IPTables для настройки правил SSH и управления трафиком

| Команда                                                                                              | Описание и пример использования                                                                                                                  |
|----------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------|
| `iptables -A INPUT -p tcp -s 172.20.236.52 --dport 22 -j ACCEPT`                                    | Разрешить входящие SSH-соединения (TCP порт 22) только с компьютера WS01 с IP 172.20.236.52.                                                    |
| `iptables -A INPUT -p tcp --dport 22 -j DROP`                                                      | Запретить все остальные SSH-подключения с любых других IP, кроме разрешённых.                                                                     |
| `iptables -I OUTPUT 1 -p tcp -d 10.0.0.15 --dport 443 -j ACCEPT`                                   | Добавить правило с высоким приоритетом (в начало цепочки OUTPUT), разрешающее исходящие HTTPS-соединения с сервером на IP 10.0.0.15.              |
| `iptables -D OUTPUT 3`                                                                             | Удалить правило из цепочки OUTPUT под номером 3 (номер правила определяется командой `iptables -L --line-numbers`).                              |
| `iptables -A OUTPUT -p tcp --dport 3306 -d 172.20.10.10 -j ACCEPT`                                 | Разрешить исходящий трафик к серверу базы данных на порт 3306 (MySQL) на IP 172.20.10.10.                                                       |
| `iptables -A OUTPUT -p tcp --dport 80 -j DROP`                                                     | Заблокировать исходящие HTTP-соединения (порт 80) на все адреса (блокировать все, кроме явно разрешённых).                                       |
| `iptables -A OUTPUT -p tcp -d 93.184.216.34 --dport 80 -j ACCEPT`                                  | Разрешить исходящий HTTP-трафик на конкретный IP 93.184.216.34 (например, сервер репозитория).                                                  |
| `iptables -A INPUT -p tcp -s 172.20.10.20 --dport 3306 -j ACCEPT`                                  | Разрешить входящие подключения к базе данных (порт 3306) только от сервера приложений с IP 172.20.10.20.                                         |
| `iptables -A INPUT -p tcp --dport 3306 -j DROP`                                                   | Запретить все прочие подключения к порту 3306 (MySQL) со всех остальных IP.                                                                       |
| `iptables -L --line-numbers -v`                                                                    | Просмотр текущих правил всех цепочек с номерами правил и подробной статистикой по пакетам и байтам.                                              |
| `iptables -F`                                                                                      | Очистить все правила во всех цепочках таблицы filter.                                                                                            |
| `iptables -X`                                                                                      | Удалить все пользовательские цепочки (созданные вручную).                                                                                        |
| `iptables -P INPUT DROP`                                                                           | Установить политику по умолчанию в цепочке INPUT на DROP — отклонять все пакеты, не попавшие под правила.                                        |
| `iptables -P OUTPUT ACCEPT`                                                                        | Установить политику по умолчанию в цепочке OUTPUT на ACCEPT — разрешать все исходящие пакеты.                                                   |
| `iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT`                          | Разрешить все пакеты, относящиеся к уже установленным или связанным соединениям.                                                                  |
| `iptables -A INPUT -i lo -j ACCEPT`                                                                | Разрешить весь трафик интерфейса loopback (localhost).                                                                                          |
| `iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT`                                    | Разрешить получение ping-запросов (ICMP echo-request).                                                                                          |
| `iptables -I INPUT 1 -p tcp --dport 22 -m limit --limit 3/min --limit-burst 3 -j ACCEPT`           | Ограничение числа новых SSH-подключений до 3 в минуту с максимальным всплеском в 3 для защиты от перебора.                                        |
| `iptables -A INPUT -j LOG --log-prefix "IPTables-Dropped: " --log-level 4`                         | Логирование пакетов, которые будут отброшены, с префиксом в системный журнал (важно для диагностики и аудита).                                   |
| `iptables-save > /etc/iptables/rules.v4`                                                         | Сохранить текущие правила в файл для автоматической загрузки после перезагрузки (пример для Debian/Ubuntu).                                     |
| `iptables-restore < /etc/iptables/rules.v4`                                                      | Восстановить правила из сохранённого файла.                                                                                                    |
| `iptables -R INPUT 2 -p tcp --dport 22 -j DROP`                                                  | Заменить правило номер 2 в цепочке INPUT на отклонение подключения к SSH (порт 22).                                                             |
| `iptables -A OUTPUT -p tcp --dport 443 -j ACCEPT`                                                | Разрешить все исходящие HTTPS-соединения.                                                                                                       |


#### Цель:
- Научиться настраивать правила для IPTables, сфокусироваться на разрешении SSH соединений и других типах трафика.

### Основные шаги и команды:
1. Добавление Входящего Правила для SSH:

![BPMN-схема бизнес-процесса](/6%20%20Доступ%20и%20права/Ipt.png)

- Цель: разрешить SSH-соединение с компьютера WS01 (IP 172.20.236.52) на сервере ETH0.1.
- Команда: iptables -A INPUT -p tcp -s 172.20.236.52 --dport 22 -j ACCEPT.
2. Отбрасывание Всех Прочих SSH Соединений:

[BPMN-схема бизнес-процесса](/6%20%20Доступ%20и%20права/Ip2.png)

- Цель: Запретить SSH для любых других источников, кроме WS01.
- Команда: iptables -A INPUT -p tcp --dport 22 -j DROP.
3. Настройка Исходящих Соединений:

[BPMN-схема бизнес-процесса](/6%20%20Доступ%20и%20права/Ipt3.png)

- Разрешить соединения на порту 3306 (сервер баз данных), порту 80 (сервер репозитория), блокировать исходящий HTTP и HTTPS за исключением доступа к определенным IP.
4. Добавление Правил через Insert:

[BPMN-схема бизнес-процесса](/6%20%20Доступ%20и%20права/Ipt4.png)

- Цель: Добавить правило с более высоким приоритетом.
- Команда: iptables -I OUTPUT [номер] -p tcp -d [IP-адрес] --dport 443 -j ACCEPT.
5. Удаление Правил:

[BPMN-схема бизнес-процесса](/6%20%20Доступ%20и%20права/Ipt5.png)


- Команда для удаления правила по порядковому номеру: iptables -D OUTPUT [номер].
### Настройка Сервера Баз Данных**:
1. Цель: Обеспечить, что трафик на порт 3306 принимается только от сервера приложений.
[BPMN-схема бизнес-процесса](/6%20%20Доступ%20и%20права/Ipt6.png)

2. Ключевые Действия:

[BPMN-схема бизнес-процесса](/6%20%20Доступ%20и%20права/Ipt7.png)

- Разрешить входящее подключение от сервера приложений.
- Отбрасывать все прочие подключения к порту базы данных.


---