# 6.13 Упражнение - IPTables


---
## Конспект

### Команды IPTables из инструкции с описанием и примером использования

| Команда                                                                                                  | Описание и пример использования                                                                                                          |
|----------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------|
| `sudo apt install iptables`                                                                              | Установка пакета IPTables на систему.                                                                                                  |
| `sudo iptables -L`                                                                                       | Просмотр текущих правил всех цепочек таблицы filter (без детального числового отображения).                                            |
| `sudo iptables -L -n`                                                                                    | Просмотр правил IPTables с выводом IP-адресов и портов в числовом формате (ускоряет отображение).                                       |
| `sudo iptables -L -n --line-numbers`                                                                     | Просмотр правил с нумерацией строк, что помогает идентифицировать правила для удаления или изменения.                                  |
| `sudo iptables -A INPUT -s <IP/Jumphost> -p tcp --dport 22 -j ACCEPT`                                     | Разрешение входящего SSH-трафика от JumpHost по порту 22.                                                                              |
| `sudo iptables -A INPUT -s <IP/App01> -p tcp --dport 80 -j ACCEPT`                                        | Разрешение входящего HTTP-трафика от сервера App01 по порту 80.                                                                        |
| `sudo iptables -A INPUT -j DROP`                                                                          | Запрет всех остальных входящих соединений, не попавших под разрешающие правила.                                                       |
| `sudo iptables -A OUTPUT -p tcp -d 172.20.235.10 --dport 3306 -j ACCEPT`                                  | Разрешение исходящего TCP-трафика на порт 3306 к серверу базы данных (пример IP).                                                     |
| `sudo iptables -A OUTPUT -p tcp -d <repo-server> --dport 80 -j ACCEPT`                                    | Разрешение исходящего TCP-трафика на порт 80 к серверу репозитория (указать IP или домен).                                             |
| `sudo iptables -A OUTPUT -p tcp -d google.com --dport 443 -j ACCEPT`                                      | Разрешение HTTPS-трафика к google.com для операций обновления или других нужд.                                                        |
| `sudo iptables -D INPUT 3`                                                                                | Удаление правила с номером 3 из цепочки INPUT (например, при разрешении проблем с подключениями).                                      |
| `sudo bash task-2.sh`                                                                                      | Запуск скрипта с названием task-2.sh, возможно для проверки или установки правил IPTables.                                              |
| `ssh ws01`                                                                                                | Подключение по SSH к машине WS01, для которой настраиваются правила IPTables.                                                         |
| `check_input.sh check_output.sh`                                                                           | Запуск скриптов для проверки корректности настроек входящего и исходящего трафика.                                                    |



### Обзор:



### Цель упражнения: Ограничить сетевой доступ к центральной машине WS01 с использованием IPTables.

![BPMN-схема бизнес-процесса](/6%20%20Доступ%20и%20права/Ipt8.png)

- Инструменты: IPTables.
- Задачи:
1. Разрешить SSH-трафик только от JumpHost.
2. Разрешить доступ на порт 80 только с сервера App01.
3. Разрешить WS01 доступ к серверу репозитория по порту 80 и к серверу баз данных по порту 3306.
4. Запретить все остальные входящие и исходящие соединения.

### Шаги выполнения и настройки:

1. Установка IPTables: sudo ipt install iptables.
2. Настройка входящего трафика (INPUT chain):
- Создание правила для разрешения SSH-трафика от JumpHost.
- Создание правила для разрешения HTTP-трафика от App01.
- Запрет всех остальных входящих соединений.
3. Проверка правил входящего трафика: Использование скрипта для проверки правильности установленных правил.
4. Настройка исходящего трафика (OUTPUT chain):
- Добавление правила для разрешения доступа к серверу баз данных через порт 3306 и доступа к серверу репозитория через порт 80.
- Запрет всех остальных исходящих соединений, кроме HTTP и HTTPS.
5. Проверка правил исходящего трафика: Использование второго скрипта для верификации настройки.
6. Исключения для операций обновления: Добавление правил, разрешающих HTTPS-соединения с определёнными серверами Ubuntu для операций обновления системы.
7. Финальная проверка: Удаление ограничивающих правил, если они мешают корректной работе системы, в частности, с apt-update.
8. Сброс настроек IPTables: Возвращение настроек IPTables к исходному состоянию.

---