# 7.3 Трансляция сетевых адресов

---

## Конспект

#### Примеры настройки NAT в Linux с командами iptables

| Команда / Действие                                                       | Описание и пример использования                                                                                             |
|-------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------|
| `iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE`                   | Настройка маскарадинга – исходящий трафик с локальной сети будет иметь IP адрес интерфейса eth0.                              |
|                                                                         | Пример: если у вас частная сеть 192.168.1.0/24 и выход в интернет через eth0, эта команда заменит исходящий IP на публичный.|
| `iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:80` | Перенаправление входящего HTTP-трафика на локальный сервер с IP 192.168.1.100 порт 80 (проброс порта).                   |
|                                                                         | Позволяет внешним пользователям обращаться к внутреннему веб-серверу через роутер.                                           |
| `iptables -t nat -L -n -v`                                               | Просмотр текущих правил NAT с подробной информацией о пакетах и байтах                                                      |
|                                                                         | Полезно для проверки и отладки настроек трансляции сетевых адресов.                                                         |
| Включение перезапуск IP пересылки:                                     | `echo 1 > /proc/sys/net/ipv4/ip_forward`                                                                                    |
|                                                                         | Нужно для того, чтобы роутер пересылал пакеты между интерфейсами — обязательное условие для работы NAT.                     |
| Добавление команды в системные настройки для IP пересылки:             | В файле `/etc/sysctl.conf` добавить строку `net.ipv4.ip_forward=1` и применить `sysctl -p`                                    |
| Удаление правила NAT                                                   | `iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE`                                                                       |
|                                                                         | Удаляет правило маскарадинга, если оно больше не требуется.                                                                  |

---

### Общий пример применения NAT для доступа в интернет из локальной сети

1. Включить IP forwarding
```commandline
echo 1 > /proc/sys/net/ipv4/ip_forward
```



2. Добавить правило маскарадинга для выхода в интернет через eth0
```commandline
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```

3. Проверить таблицу NAT
```commandline
iptables -t nat -L -n -v
```

Введение: Привет! В этой лекции изучим основы трансляции сетевых адресов (NAT), ключевой концепции для понимания работы сетей. Несмотря на то что обсуждение не ограничивается работой с Linux, знания о NAT критически важны для глубокого понимания сетевых взаимодействий.

### Основные понятия:

![BPMN-схема бизнес-процесса](/7%20%20Сеть%20в%20Linux/Trans.png)

1. NAT (Network Address Translation) – механизм в сетевых технологиях, позволяющий транслировать частные IP-адреса в публичные и обратно.
2. Частные и публичные IP-адреса – адреса, используемые внутри локальной сети и в Интернете соответственно.

### Пример работы NAT:


![BPMN-схема бизнес-процесса](/7%20%20Сеть%20в%20Linux/Trans2.png)

1. Имеем два компьютера в локальной сети, роутер с публичным IP-адресом, обеспечивающий выход в Интернет.

![BPMN-схема бизнес-процесса](/7%20%20Сеть%20в%20Linux/Trans3.png)

2. Компьютеры связаны через коммутатор с роутером, который становится частью локальной сети.
3. При отправке запроса в Интернет с одного из компьютеров, роутер использует NAT для преобразования частного IP-адреса отправителя в публичный.

![BPMN-схема бизнес-процесса](/7%20%20Сеть%20в%20Linux/Trans4.png)

4. При получении ответа, роутер использует таблицу NAT для определения, к какому компьютеру в локальной сети нужно направить ответ.
5. Аналогия: Можно сравнить NAT с работой почты на секретном заводе, где все письма отправляются и приходят через единый почтовый ящик, а почтальон знает, кому и как переслать каждое письмо.

### Примеры использования NAT в Linux:


![BPMN-схема бизнес-процесса](/7%20%20Сеть%20в%20Linux/Trans5.png)

- Чтобы позволить взаимодействие различных сетевых сегментов, настраиваются маршруты и правила NAT через iptables, что позволяет транслировать адреса из одной подсети в другую.
- NAT может использоваться для скрытия внутренней структуры сети, обеспечения дополнительного уровня безопасности и экономии публичных IP-адресов.

---