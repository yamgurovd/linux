# 7  Сеть в Linux


## Содержание блока

---

- [7.1 Введение](/7%20%20Сеть%20в%20Linux/7.1%20Введение.md)
- [7.2 Основы сети](/7%20%20Сеть%20в%20Linux/7.2%20Основы%20сети.md)
- [7.3 Трансляция сетевых адресов](/7%20%20Сеть%20в%20Linux/7.3%20Трансляция%20сетевых%20адресов.md)
- [7.4 Сети в VM](/7%20%20Сеть%20в%20Linux/7.4%20Сети%20в%20VM.md)
- [7.6 Domain Name System](/7%20%20Сеть%20в%20Linux/7.6%20Domain%20Name%20System.md)
- [7.8 Инструменты диагностики сети](/7%20%20Сеть%20в%20Linux/7.8%20Инструменты%20диагностики%20сети.md)
- [7.9 Устранение проблем](/7%20%20Сеть%20в%20Linux/7.9%20Устранение%20проблем.md)


---

## Используемые команды всего блока


#### Популярные сетевые команды

| Команда                                         | Результат / Описание                                                    | Пояснение и пример использования                                                                                   |
|------------------------------------------------|------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------|
| `ip link`                                      | Просмотр всех сетевых интерфейсов                                     | Команда показывает все сетевые интерфейсы и их состояние. Например, `eth0`, `lo`.                                    |
| `ip addr add 192.168.1.10/24 dev eth0`        | Назначение IP-адреса 192.168.1.10 с маской 255.255.255.0 интерфейсу eth0| Устанавливает локальный IP; полезно при настройке статического адреса: `ip addr add 192.168.1.10/24 dev eth0`          |
| `ip addr show dev eth0`                        | Показать IP-адреса конкретного интерфейса eth0                        | Проверить, какие адреса назначены интерфейсу: `ip addr show dev eth0`                                               |
| `ping 192.168.1.11`                            | Проверка доступности хоста с IP 192.168.1.11                          | Отправка ICMP-запросов для проверки сетевого соединения: `ping 192.168.1.11`                                        |
| `route`                                        | Просмотр таблицы маршрутизации (устаревшая команда)                   | Для быстрой проверки маршрутов в старых системах: `route`                                                           |
| `ip route`                                     | Просмотр таблицы маршрутизации                                        | Современный способ увидеть маршруты. Например, `ip route` выдаст маршруты с сетями и шлюзами                         |
| `ip route add 192.168.2.0/24 via 192.168.1.1` | Добавление маршрута к сети 192.168.2.0 через шлюз 192.168.1.1          | В системе настроен маршрут в другую подсеть через указанный шлюз. Например: `ip route add 192.168.2.0/24 via 192.168.1.1` |
| `ip route add default via 192.168.2.1`         | Назначить шлюз по умолчанию (default gateway) 192.168.2.1              | Настроить маршрут по умолчанию для доступа в интернет: `ip route add default via 192.168.2.1`                         |
| `clear`                                        | Очистить экран терминала                                              | Просто убирает весь вывод из терминала для удобства                                                                   |
| `ip link set eth0 up`                          | Включение сетевого интерфейса eth0                                   | Активировать интерфейс: полезно при изменении конфигурации или после отключения                                      |
| `ip link set eth0 down`                        | Отключение сетевого интерфейса eth0                                  | Отключить интерфейс, например для временной деактивации или диагностики                                             |
| `ethtool eth0`                                 | Посмотреть параметры интерфейса eth0                                 | Вывести техническую информацию: скорость, режим дуплекса, настройки автосогласования                                 |
| `nslookup google.com`                          | Получить IP-адрес домена google.com                                  | Проверить, как разрешается доменное имя, например: `nslookup google.com`                                            |
| `traceroute 8.8.8.8`                           | Проследить маршрут до IP 8.8.8.8                                     | Показать, через какие хосты проходит пакет до Google DNS сервера                                                   |
| `netstat -rn`                                  | Показать таблицу маршрутизации с номерами                            | Показать маршруты с IP в числовом виде, без перевода имен интерфейсов                                               |



#### Примеры настройки NAT в Linux с командами iptables

| Команда / Действие                                                       | Описание и пример использования                                                                                             |
|-------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------|
| `iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE`                   | Настройка маскарадинга – исходящий трафик с локальной сети будет иметь IP адрес интерфейса eth0.                              |
|                                                                         | Пример: если у вас частная сеть 192.168.1.0/24 и выход в интернет через eth0, эта команда заменит исходящий IP на публичный.|
| `iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:80` | Перенаправление входящего HTTP-трафика на локальный сервер с IP 192.168.1.100 порт 80 (проброс порта).                   |
|                                                                         | Позволяет внешним пользователям обращаться к внутреннему веб-серверу через роутер.                                           |
| `iptables -t nat -L -n -v`                                               | Просмотр текущих правил NAT с подробной информацией о пакетах и байтах                                                      |
|                                                                         | Полезно для проверки и отладки настроек трансляции сетевых адресов.                                                         |
| Включение перезапуск IP пересылки:                                     | `echo 1 > /proc/sys/net/ipv4/ip_forward`                                                                                    |
|                                                                         | Нужно для того, чтобы роутер пересылал пакеты между интерфейсами — обязательное условие для работы NAT.                     |
| Добавление команды в системные настройки для IP пересылки:             | В файле `/etc/sysctl.conf` добавить строку `net.ipv4.ip_forward=1` и применить `sysctl -p`                                    |
| Удаление правила NAT                                                   | `iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE`                                                                       |
|                                                                         | Удаляет правило маскарадинга, если оно больше не требуется.                                                                  |



#### Команды и понятия для настройки сетей в VirtualBox и Linux

| Команда / Понятие                                            | Результат / Описание                                                    | Пояснение и пример использования                                                                                              |
|--------------------------------------------------------------|------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------|
| `VBoxManage list hostonlyifs`                                | Просмотр доступных host-only сетевых интерфейсов VirtualBox            | Показывает созданные VirtualBox host-only интерфейсы, например `vboxnet0`.                                                    |
| `VBoxManage hostonlyif create`                               | Создание нового host-only интерфейса                                   | Создаёт новую изолированную сеть между виртуальными машинами и хостом.                                                        |
| `VBoxManage hostonlyif ipconfig vboxnet0 --ip 192.168.56.1`  | Настройка IP-адреса для host-only интерфейса `vboxnet0`                | Настраивает IP и маску для виртуальной сети хоста в VirtualBox.                                                               |
| `VBoxManage modifyvm <VM_NAME> --nic1 nat`                   | Установка первого сетевого адаптера ВМ в режим NAT                     | Режим NAT обеспечивает доступ ВМ в интернет через хост, но скрывает ВМ от внешней сети.                                        |
| `VBoxManage modifyvm <VM_NAME> --nic2 hostonly`              | Назначение второго адаптера для ВМ в режим Host-only                   | Сеть, где ВМ общаются между собой и с хостом, без выхода в интернет.                                                          |
| `VBoxManage modifyvm <VM_NAME> --nic3 bridged`               | Присвоение третьему адаптеру Bridge mode                                | ВМ становится полноценным участником локальной сети с доступом к интернету и другим устройствам.                               |
| `VBoxManage controlvm <VM_NAME> natpf1 "guestssh,tcp,,2222,,22"` | Проброс порта с хоста на ВМ (порт 2222 на хосте → 22 в ВМ)            | Позволяет подключаться с хоста через SSH к ВМ, работающей в режиме NAT.                                                       |
| `ip a` или `ip addr`                                         | Показать все сетевые интерфейсы и IP-адреса                            | Используется для просмотра текущих сетевых интерфейсов и их конфигураций на хосте или ВМ.                                      |
| `ip link set dev <интерфейс> up`                             | Включить сетевой интерфейс                                             | Активирует указанный интерфейс, например `ip link set dev eth0 up`.                                                           |
| `ip link set dev <интерфейс> down`                           | Отключить сетевой интерфейс                                            | Деактивирует интерфейс, например `ip link set dev eth0 down`.                                                                  |
| `ping <ip_адрес>`                                            | Проверка доступности хоста по сети                                    | Отправляет ICMP-запросы, например: `ping 192.168.56.101` для проверки связи с ВМ.                                            |
| `traceroute <ip_адрес>`                                      | Проследить маршрут до хоста                                           | Позволяет увидеть через какие шлюзы идут пакеты до цели, полезно для диагностики.                                              |
| `route` или `ip route`                                       | Просмотр таблицы маршрутизации                                         | Выводит маршруты сети, важен для понимания, через какие шлюзы идет трафик.                                                    |
| `ip route add <сеть> via <шлюз>`                            | Добавить статический маршрут                                           | Настраивает новый маршрут к подсети через указанный шлюз, например: `ip route add 192.168.56.0/24 via 192.168.1.1`             |
| `ifconfig vboxnet0`                                           | Просмотр настроек VirtualBox host-only интерфейса                      | Позволяет увидеть IP и статус интерфейса `vboxnet0`.                                                                            |
| `systemctl restart network`                                  | Перезапуск сетевой службы на хосте                                    | Иногда нужен после изменений в конфигурации сети для их применения.                                                            |
| `iptables -t nat -L -n -v`                                   | Просмотр правил NAT в firewall                                         | Для диагностики переадресации портов и трансляции адресов.                                                                     |
| NAT (Network Address Translation)                           | Режим подключения ВМ через хост                                        | Виртуальная машина может выходить в интернет, но сама скрыта за IP хоста.                                                     |
| Host-only Network                                           | Изолированная сеть между хостом и ВМ                                   | ВМ общаются между собой и с хостом без доступа в интернет.                                                                     |
| Bridge Network                                              | ВМ становятся видимы как полноценные устройства внутри локальной сети | ВМ получают IP из общей сети, могут взаимодействовать с другими узлами ЛВС и выходить в интернет напрямую.                    |
| `VBoxManage list vif`                                       | Просмотр всех виртуальных интерфейсов VirtualBox                      | Показывает все сетевые интерфейсы ВМ, их типы и состояние.                                                                     |
| `VBoxManage showvminfo <VM_NAME>`                            | Показать подробную информацию о настройках ВМ                        | Помогает проверить конфигурацию сети VM (режимы адаптеров, MAC-адреса и др.)                                                  |
| `VBoxManage controlvm <VM_NAME> setlinkstate1 off/on`         | Отключить/включить сетевой адаптер 1 ВМ                              | Быстрая деактивация или активация сетевого адаптера без выключения ВМ.                                                        |
| `nmcli device status`                                       | Проверка состояния сетевых устройств в NetworkManager                 | Полезно на современных дистрибутивах Linux для контроля интерфейсов.                                                          |



#### Основные команды и понятия для работы с DNS в Linux

| Команда / Понятие                                       | Результат / Описание                                           | Пояснение и пример использования                                                                                   |
|--------------------------------------------------------|---------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------|
| `/etc/hosts`                                           | Локальный файл для сопоставления имён с IP-адресами           | Добавление записей вида `192.168.1.10 db-server` позволит вызывать хост по имени без использования DNS-сервера.       |
| `/etc/nsswitch.conf`                                   | Файл конфигурации порядка разрешения имён                      | Строка `hosts: files dns` означает сначала проверку `/etc/hosts`, потом DNS. Можно менять порядок для тестов.          |
| `/etc/resolv.conf`                                     | Файл настройки DNS-серверов                                    | Добавьте строки `nameserver 8.8.8.8` или `nameserver 192.168.1.100` для указания DNS-серверов, используемых системой. |
| `ping <hostname_or_ip>`                                | Проверка доступности хоста или IP                              | Проверяет доходят ли пакеты до целевого хоста, например `ping db-server` или `ping 192.168.1.10`.                      |
| `nslookup <hostname>`                                  | Запрос разрешения имени у DNS сервера                          | Отображает IP-адрес, связанный с именем, а также использованный DNS-сервер.                                          |
| `dig <hostname> [тип_записи]`                         | Гибкий DNS-запрос с выводом подробной информации               | Пример: `dig www.example.com A` покажет IPv4 адреса; `dig www.example.com AAAA` — IPv6.                                |
| `host <hostname>`                                      | Простая утилита для проверки DNS-разрешения                    | Быстрый способ узнать IP по имени, например: `host db-server`                                                        |
| Тип записи A                                           | Соответствие имени хоста IPv4-адресу                           | Используется для сопоставления имён с IPv4 адресами.                                                                 |
| Тип записи AAAA                                        | Соответствие имени хоста IPv6-адресу                           | Аналогично A, но для IPv6 адресов.                                                                                   |
| Тип записи CNAME                                       | Псевдонимы для доменных имён                                   | Позволяет указать, что одно имя является алиасом другого, например: `www -> webserver1`.                              |
| `search <domain>` в /etc/resolv.conf                   | Домены для поиска при разрешении коротких имён                 | Позволяет обращаться к хостам без полного имени, как `db-server` вместо `db-server.corp.example.com`.                  |
| Иерархия доменных имён                                | Структура из доменов и поддоменов                              | Пример: `app.corp.example.com` — поддомен `app` внутри `corp.example.com`.                                            |



### Проверка состояния сетевых интерфейсов

| Команда / Понятие           | Результат / Описание                         | Пояснение и пример использования                                                |
|----------------------------|---------------------------------------------|---------------------------------------------------------------------------------|
| `ip link`                  | Просмотр состояния интерфейсов (включен/выключен), MAC-адреса | Проверяем, активен ли интерфейс eth0: `ip link show eth0`                       |
| `ip addr` / `ip a`         | Просмотр IP-адресов интерфейсов              | Проверяем IP адреса: `ip addr show wlan0`                                      |
| `ifconfig`                 | Старый инструмент показа интерфейсов         | Запуск `ifconfig` покажет все сетевые интерфейсы с IP.                         |
| `dmesg | grep -i eth`      | Проверка записей ядра об Ethernet устройствах| `dmesg | grep -i eth` – ищем ошибки драйверов сетевых карт.                    |
| `ip route` / `ip r`        | Таблица маршрутов                            | `ip route` покажет пути, например, `default via 192.168.1.1 dev eth0`          |
| `route`                    | Альтернативный вывод таблицы маршрутов       | `route -n` – таблица маршрутов без резолвинга IP в имена хостов.              |

---

### Проверка сетевых пакетов и связности

| Команда / Понятие           | Результат / Описание                         | Пояснение и пример использования                                                |
|----------------------------|---------------------------------------------|---------------------------------------------------------------------------------|
| `ping <хост_или_IP>`       | Проверка доступности хоста                   | `ping ya.ru` — проверка доступности сайта, `ping 8.8.8.8` — напрямую DNS Google |
| `arp -vn`                  | Просмотр таблицы ARP (MAC-адреса)            | `arp -vn` покажет известные MAC-адреса в локальной сети, если ICMP блокируется  |
| `traceroute -I -n <хост>` | Отслеживает маршрут ICMP-пакетов             | `traceroute -I -n ya.ru` покажет количество прыжков и IP адреса маршрутизаторов |
| `tracepath -n <хост>`      | Аналог traceroute без необходимости root     | `tracepath -n ya.ru` — полезно, если нет root-доступа                           |
| `mtr <хост>`               | Интерактивный просмотр пути и потерь пакетов | `mtr ya.ru` показывает непрерывный маршрут и время отклика                      |

---

### Диагностика DNS

| Команда / Понятие                     | Результат / Описание                                | Пояснение и пример использования                                                              |
|--------------------------------------|----------------------------------------------------|------------------------------------------------------------------------------------------------|
| `host <хост>`                       | Простая проверка разрешения имени в IP              | `host ya.ru` выведет IP адреса сайта и DNS-сервер, который ответил                            |
| `dig <хост> [тип_записи]`          | Гибкий запрос DNS с выводом детальной информации    | `dig ya.ru A` покажет IPv4 адреса, `dig ya.ru AAAA` — IPv6                                   |
| `nslookup <хост>`                   | Стандартный запрос к DNS серверу                      | `nslookup ya.ru` – проверяет IP и DNS-сервер                                                 |
| `nmcli connection show eth0 | grep dns` | Проверка DNS-серверов, назначенных для интерфейса   | `nmcli connection show eth0 | grep dns` покажет DNS, привязанный к eth0                        |
| `systemd-resolve --status`          | Статус резолвинга DNS через systemd                   | `systemd-resolve --status` — детальный вывод текущих DNS-серверов и настроек                |

---

### Проверка портов и протоколов

| Команда / Понятие           | Результат / Описание                                   | Пояснение и пример использования                                                  |
|----------------------------|-------------------------------------------------------|-----------------------------------------------------------------------------------|
| `ss -tupn`                 | Просмотр открытых TCP/UDP соединений с процессами     | `ss -tupn` — показываются IP-адреса, порты и PID процессов                       |
| `netstat -tulpn`           | Альтернативный просмотр прослушиваемых портов         | `netstat -tulpn | grep :22` фильтрует SSH соединения                            |
| `lsof -i -P -n`            | Список процессов, использующих сетевые подключения     | `lsof -i -P -n | grep LISTEN` — кто слушает порты                                  |
| `telnet <host> <port>`     | Проверка открытости TCP порта                           | `telnet db01 3306` проверит доступность MySQL порта                              |
| `nc -zv <host> <port>`     | Проверка доступности порта без отправки данных         | `nc -zv 192.168.1.100 80` — проверка HTTP порта                                 |
| `nmap <host> -p <порты>`   | Сканирование портов хоста                               | `nmap db01 -p 22,80,3306` — сканирование нужных портов                           |

---

### Работа с firewall и iptables

| Команда / Понятие            | Результат / Описание                                   | Пояснение и пример использования                                                        |
|-----------------------------|-------------------------------------------------------|-----------------------------------------------------------------------------------------|
| `iptables -L`               | Просмотр текущих правил iptables                        | `iptables -L` — базовый просмотр правил, без root можно использовать `sudo`             |
| `firewall-cmd --list-all`   | Просмотр текущих правил firewalld                       | `firewall-cmd --list-all` — вывод активной зоны, открытых портов                        |
| `firewall-cmd --add-port=8080/tcp --permanent` | Открытие порта 8080 TCP, перманентно               | Чтобы применить: `firewall-cmd --reload`                                                  |
| `firewall-cmd --remove-port=8080/tcp --permanent` | Закрытие порта 8080 TCP, перманентно               | И перезагрузка `firewall-cmd --reload`                                                  |



## Проверка состояния сетевых интерфейсов

| Команда / Понятие           | Результат / Описание                                   | Пояснение и пример использования                                           |
|----------------------------|-------------------------------------------------------|----------------------------------------------------------------------------|
| `ip link`                  | Список сетевых интерфейсов с состоянием (UP/DOWN), MAC | Проверяем, поднят ли интерфейс eth0: <br>`ip link show eth0` <br>Пример вывода: <br>`2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 ...` |
| `ip addr` / `ip a`         | Список интерфейсов с IP-адресами                      | `ip addr show wlan0` <br>Вывод с IP: <br>`inet 192.168.1.15/24 brd 192.168.1.255 scope global wlan0` |
| `ifconfig`                 | Старый инструмент со схожей информацией               | Запуск <br>`ifconfig eth0` <br>Покажет IP, состояние и статистику интерфейса |
| `dmesg | grep -i eth`      | Логи ядра по Ethernet устройствам                      | `dmesg | grep -i eth` <br>Пример: <br>`e1000e 0000:00:19.0: eth0: Intel(R) PRO/1000 Network Connection` |
| `ip route` / `ip r`        | Таблица маршрутов                                     | `ip route` <br>Пример: <br>`default via 192.168.1.1 dev eth0 proto dhcp metric 100` |
| `route -n`                 | Аналог без резолвинга DNS имен                        | `route -n` <br>Вывод: <br>`0.0.0.0 192.168.1.1 0.0.0.0 UG 100 0 0 eth0`    |

## Проверка соединения и разрешения имен

| Команда / Понятие           | Результат / Описание                                   | Пояснение и пример использования                                           |
|----------------------------|-------------------------------------------------------|----------------------------------------------------------------------------|
| `nslookup <хост>`           | IP-адрес по имени хоста                               | `nslookup ya.ru` <br>Результат: <br>`Address: 87.250.250.242`              |
| `ping <хост_или_IP>`        | Проверка доступности хоста                            | `ping -c 4 8.8.8.8` <br>4 пакета ICMP, статистика потерь и времени         |
| `arp -vn`                   | Таблица сопоставления IP и MAC в локальной сети      | `arp -vn` <br>Вывод: <br>`? (192.168.1.1) at 00:11:22:33:44:55 [ether] on eth0` |
| `traceroute -I -n <хост>`  | Трассировка маршрута через ICMP                       | `traceroute -I -n ya.ru` <br>Показывает IP промежуточных узлов (без DNS)   |
| `tracepath -n <хост>`       | Безопасная трассировка без root                       | `tracepath -n ya.ru` <br>Вывод маршрута с временем задержек                |
| `mtr <хост>`                | Интерактивное отслеживание маршрута и потерь пакетов | `mtr ya.ru` (Ctrl+C для выхода) показывает обновляющуюся таблицу пути       |

## Проверка состояния сервисов и портов

| Команда / Понятие            | Результат / Описание                                  | Пояснение и пример использования                                           |
|-----------------------------|------------------------------------------------------|----------------------------------------------------------------------------|
| `ss -tuln`                  | Список прослушиваемых TCP и UDP портов              | `ss -tuln` <br>Пример: <br>`LISTEN 0 128 0.0.0.0:80` — веб-сервер nginx слушает порт 80 |
| `netstat -tuln`             | Аналог ss                                             | Запуск `netstat -tuln` даёт похожий вывод о портах                         |
| `systemctl status <служба>` | Проверка статуса службы                               | `systemctl status nginx` <br>Информация о состоянии и журнал ошибок       |
| `systemctl restart <служба>`| Перезапуск службы                                    | `sudo systemctl restart nginx` — перезапускает nginx                      |

